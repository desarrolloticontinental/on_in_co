&ANALYZE-SUSPEND _VERSION-NUMBER UIB_v8r12
&ANALYZE-RESUME
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CUSTOM _DEFINITIONS Procedure 
/*--------------------------------------------------------------------------
    File        :
    Purpose     :

    Syntax      :

    Description :

    Author(s)   :
    Created     :
    Notes       :
  ------------------------------------------------------------------------*/
/*          This .W file was created with the Progress UIB.             */
/*----------------------------------------------------------------------*/

/* ***************************  Definitions  ************************** */

DEFINE INPUT PARAMETER X-Rowid AS ROWID.
/* RHC 14/04/2015 Parámetro sin uso */
DEFINE INPUT PARAMETER x-ContaFinan AS LOGICAL.


DEFINE STREAM Reporte.

DEFINE SHARED VAR S-CODCIA AS INTEGER.
DEFINE SHARED VAR S-NOMCIA AS CHAR.
DEFINE SHARED VAR S-CODALM AS CHAR.
DEFINE SHARED VAR S-DESALM AS CHAR.
DEFINE SHARED VAR S-USER-ID AS CHAR.

DEFINE VAR S-Procedencia AS CHAR FORMAT "X(55)" INIT "".
DEFINE VAR S-Moneda      AS CHAR FORMAT "X(32)"  INIT "".
DEFINE VAR S-Mon         AS CHAR FORMAT "X(4)"  INIT "".
DEFINE VAR S-Referencia1 AS CHAR FORMAT "X(16)" INIT "".
DEFINE VAR S-Referencia2 AS CHAR FORMAT "X(16)" INIT "".
DEFINE VAR S-Referencia3 AS CHAR FORMAT "X(16)" INIT "".
DEFINE VAR S-Encargado   AS CHAR FORMAT "X(32)" INIT "".
DEFINE VAR S-RUC         AS CHAR FORMAT "X(32)" INIT "".
DEFINE VAR S-Movimiento  AS CHAR FORMAT "X(40)" INIT "".
DEFINE VAR S-TOTAL       AS DECIMAL INIT 0.
DEFINE VAR S-SUBTO       AS DECIMAL INIT 0.
DEFINE VAR S-Item        AS INTEGER INIT 0.
DEFINE VAR W-VTA0        AS DECIMAL INIT 0.
DEFINE VAR W-VTA1        AS DECIMAL INIT 0.
DEFINE VAR W-VTA2        AS DECIMAL INIT 0.

DEFINE VAR lNomAlm AS CHAR.

FIND Almacen WHERE Almacen.CodCia = S-CODCIA AND
     Almacen.CodAlm = S-CODALM NO-LOCK NO-ERROR.
     S-Encargado = Almacen.EncAlm.

     lNomAlm = almacen.descripcion.

DEFINE VAR s-task-no AS INT.
DEFINE BUFFER b-w-report FOR w-report.

DEFINE VAR x-impresora-destino AS INT.
DEFINE VAR x-ruta-file-pdf AS CHAR.

/* -------------------------------------------------- */
DEF VAR RB-REPORT-LIBRARY AS CHAR.
DEF VAR RB-REPORT-NAME AS CHAR INITIAL "ticket comprobante electronico".
DEF VAR RB-INCLUDE-RECORDS AS CHAR INITIAL "".
DEF VAR RB-FILTER AS CHAR INITIAL "".
DEF VAR RB-OTHER-PARAMETERS AS CHAR INITIAL "".     
DEF VAR RB-DB-CONNECTION AS CHAR INITIAL "".
DEF VAR RB-MEMO-FILE AS CHAR INITIAL "".
DEF VAR RB-PRINT-DESTINATION AS CHAR INITIAL "".
DEF VAR RB-PRINTER-NAME AS CHAR INITIAL "".
DEF VAR RB-PRINTER-PORT AS CHAR INITIAL "".
DEF VAR RB-OUTPUT-FILE AS CHAR INITIAL "".
DEF VAR RB-NUMBER-COPIES AS INTEGER INITIAL 1.
DEF VAR RB-BEGIN-PAGE AS INTEGER INITIAL 0.
DEF VAR RB-END-PAGE AS INTEGER INITIAL 0.
DEF VAR RB-TEST-PATTERN AS LOGICAL INITIAL NO.
DEF VAR RB-WINDOW-TITLE AS CHARACTER INITIAL "".
DEF VAR RB-DISPLAY-ERRORS AS LOGICAL INITIAL YES.
DEF VAR RB-DISPLAY-STATUS AS LOGICAL INITIAL YES.
DEF VAR RB-NO-WAIT AS LOGICAL INITIAL NO.

/* capturamos ruta inicial */
DEF VAR S-REPORT-LIBRARY AS CHAR.
GET-KEY-VALUE SECTION "Startup" KEY "BASE" VALUE s-report-library.

/*RB-REPORT-LIBRARY = s-report-library + "vta2/rbvta2.prl".*/

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&ANALYZE-SUSPEND _UIB-PREPROCESSOR-BLOCK 

/* ********************  Preprocessor Definitions  ******************** */

&Scoped-define PROCEDURE-TYPE Procedure
&Scoped-define DB-AWARE no



/* _UIB-PREPROCESSOR-BLOCK-END */
&ANALYZE-RESUME



/* *********************** Procedure Settings ************************ */

&ANALYZE-SUSPEND _PROCEDURE-SETTINGS
/* Settings for THIS-PROCEDURE
   Type: Procedure
   Allow: 
   Frames: 0
   Add Fields to: Neither
   Other Settings: CODE-ONLY COMPILE
 */
&ANALYZE-RESUME _END-PROCEDURE-SETTINGS

/* *************************  Create Window  ************************** */

&ANALYZE-SUSPEND _CREATE-WINDOW
/* DESIGN Window definition (used by the UIB) 
  CREATE WINDOW Procedure ASSIGN
         HEIGHT             = 6.96
         WIDTH              = 56.86.
/* END WINDOW DEFINITION */
                                                                        */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CUSTOM _INCLUDED-LIB Procedure 
/* ************************* Included-Libraries *********************** */

{src/bin/_prns.i}

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


 


&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CUSTOM _MAIN-BLOCK Procedure 


/* Impresion Directa */

/*MLR* 29/10/07 */

/* IC - 26Ago2022
DEFINE VARIABLE answer AS LOGICAL NO-UNDO.
SYSTEM-DIALOG PRINTER-SETUP UPDATE answer.
IF answer THEN RUN Imprime_FR.

*/

x-impresora-destino = -1.

RUN gn/d-impresion-destino.r(OUTPUT x-impresora-destino).

IF x-impresora-destino = -1 THEN DO:
  RETURN.
END.
/*
IF x-impresora-destino = 2 THEN DO:
  MESSAGE "No esta disponible la impresion hacia impresora de tinta/laser"
      VIEW-AS ALERT-BOX INFORMATION.
  RETURN. 
END.
*/
CASE x-impresora-destino:
    WHEN 1 THEN DO:
        /* Matricial */
        DEFINE VARIABLE answer AS LOGICAL NO-UNDO.
        SYSTEM-DIALOG PRINTER-SETUP UPDATE answer.
        IF answer THEN RUN Imprime_FR.
    END.
    WHEN 3 THEN DO:
        /* Archivo PDF */
        DEFINE VAR lDirectorio AS CHAR.
        lDirectorio = "".

        IF x-impresora-destino = 3 THEN DO:
            SYSTEM-DIALOG GET-DIR lDirectorio  
               RETURN-TO-START-DIR 
               TITLE 'Directorio Files'.
            IF lDirectorio = "" THEN DO :
                RETURN.
            END.
            ELSE DO:
                /*x-ruta-pdf = lDirectorio.*/
                x-ruta-file-pdf = lDirectorio.
            END.
        END.

        RUN Imprime_FR.
    END.
    WHEN 2 THEN DO:
        /* Tinta/Laser */
        RUN bin/_prnctr.
        IF s-salida-impresion = 0 THEN RETURN 'OK'.     /* Usuario NO desea imprimir */ 
        RUN lib/_port-name-v2.p (s-printer-name, OUTPUT s-port-name).
        RUN Imprime_FR.
    END.
END CASE.

/*
IF x-impresora-destino = 1 THEN DO:
    DEFINE VARIABLE answer AS LOGICAL NO-UNDO.
    SYSTEM-DIALOG PRINTER-SETUP UPDATE answer.
    IF answer THEN RUN Imprime_FR.
END.
ELSE DO:

    DEFINE VAR lDirectorio AS CHAR.
    lDirectorio = "".

    IF x-impresora-destino = 3 THEN DO:
        SYSTEM-DIALOG GET-DIR lDirectorio  
           RETURN-TO-START-DIR 
           TITLE 'Directorio Files'.
        IF lDirectorio = "" THEN DO :
            RETURN.
        END.
        ELSE DO:
            /*x-ruta-pdf = lDirectorio.*/
            x-ruta-file-pdf = lDirectorio.
        END.
    END.

    RUN Imprime_FR.
END.
*/

PROCEDURE SetDefaultPrinterA EXTERNAL "WINSPOOL.drv":U :
DEFINE INPUT PARAMETER pszPrinter AS CHARACTER.
DEFINE RETURN PARAMETER ireturn AS LONG.
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


/* **********************  Internal Procedures  *********************** */

&IF DEFINED(EXCLUDE-Formato-1) = 0 &THEN

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE Formato-1 Procedure 
PROCEDURE Formato-1 :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
  DEFINE FRAME F-FMT
         Almmmatg.ArtPro    FORMAT "X(12)"
         Almdmov.CodMat     AT  14 FORMAT "X(6)"
         Almdmov.CanDes     AT  22 FORMAT ">>>,>>9.9999" 
         Almdmov.CodUnd     AT  35 FORMAT "X(4)"          
         Almmmatg.DesMat    AT  41 FORMAT "X(50)"
         Almmmatg.Desmar    AT  91 FORMAT 'x(20)'
         Almmmatg.CatConta[1] AT 115 FORMAT 'x(3)'
         Almmmate.CodUbi    AT  124
         HEADER
         {&PRN7A} + {&PRN6A} + S-NOMCIA + {&PRN7B} + {&PRN6B} FORMAT "X(45)" SKIP
         "( " + S-CODALM + " - " + lNomAlm + " )" AT 1 FORMAT "X(60)" 
         "INGRESO No. : " AT 96 Almcmov.NroDoc AT 114 SKIP
         /*"( " + S-CODALM + " )" AT 5 FORMAT "X(20)" */
         S-Movimiento  AT 52 "Pag. " AT 108 PAGE-NUMBER(REPORTE) FORMAT ">>9" SKIP(1)
         S-PROCEDENCIA AT 1 FORMAT "X(70)" S-RUC AT 79 "Fecha : " AT 113 Almcmov.FchDoc AT 121 SKIP
/*          S-Referencia2 AT 1 ": " Almcmov.NroRf2  AT 20 "Almacen Ingreso : " AT 79 S-CODALM AT 99       "Hora  : " AT 113 Almcmov.HorRcp AT 121 SKIP */
         S-Referencia3 AT 1 ": " Almcmov.NroRf3  AT 20 "Almacen Ingreso : " AT 79 S-CODALM AT 99       "Hora  : " AT 113 Almcmov.HorRcp AT 121 SKIP 
         S-Referencia1 AT 1 ": " Almcmov.NroRf1  AT 20 S-MONEDA AT 79 SKIP
         "Observaciones    : " AT 1 Almcmov.Observ  AT 20 "Responsable     : " AT 79 S-Encargado AT 99 SKIP
         "-----------------------------------------------------------------------------------------------------------------------------------" SKIP
         " COD.PROV.   CODIGO    CANTIDAD    UND.                  DESCRIPCION                          M A R C A           CC      UBICACION" SKIP
         "-----------------------------------------------------------------------------------------------------------------------------------" SKIP
        /*         1         2         3         4         5         6         7         8         9        10        11        12        13        14*/ 
        /*12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890*/
        /*123456789012 123456  >>>,>>9.9999 1234  1234567890123456789012345678901234567890123456789012345678901234567890    123      123 */
         WITH NO-LABEL NO-UNDERLINE NO-BOX WIDTH 145 STREAM-IO DOWN.         
         
  OUTPUT STREAM Reporte TO PRINTER PAGED PAGE-SIZE 31.
  FIND FIRST Almdmov WHERE Almdmov.CodCia = Almcmov.CodCia AND
             Almdmov.CodAlm = Almcmov.CodAlm AND
             Almdmov.TipMov = Almcmov.TipMov AND
             Almdmov.CodMov = Almcmov.CodMov AND
             Almdmov.NroDoc = Almcmov.NroDoc USE-INDEX Almd01 NO-LOCK NO-ERROR.
  IF AVAILABLE Almdmov THEN DO:
     PUT STREAM Reporte CONTROL {&PRN0} + {&PRN5A} + CHR(33) + {&PRN3}.     
     REPEAT WHILE  AVAILABLE  AlmDMov      AND Almdmov.CodAlm = Almcmov.CodAlm AND
           Almdmov.TipMov = Almcmov.TipMov AND Almdmov.CodMov = Almcmov.CodMov AND
           Almdmov.NroDoc = Almcmov.NroDoc:
           FIND Almmmatg WHERE Almmmatg.CodCia = Almdmov.CodCia AND
                Almmmatg.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.
           FIND Almmmate WHERE Almmmate.Codcia = Almdmov.CodCia AND
                Almmmate.CodAlm = S-CODALM AND
                Almmmate.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.
           DISPLAY STREAM Reporte 
                   Almdmov.CodMat 
                   Almdmov.CanDes 
                   Almdmov.CodUnd 
                   Almmmatg.ArtPro 
                   Almmmatg.DesMat 
                   Almmmate.CodUbi
                   Almmmatg.Desmar 
                   Almmmatg.CatConta[1]
                   WITH FRAME F-FMT.
           DOWN STREAM Reporte WITH FRAME F-FMT.
           FIND NEXT Almdmov USE-INDEX Almd01. 
     END.
  END.
  DO WHILE LINE-COUNTER(Reporte) < PAGE-SIZE(Reporte) - 6 :
     PUT STREAM Reporte "" skip.
  END.
  PUT STREAM Reporte "    -----------------            -----------------            -----------------            ----------------- " AT 10 SKIP.
  PUT STREAM Reporte "        Operador                      Recibido                      Vo. Bo.                   ADMINISTRADOR  " AT 10 SKIP.
  PUT STREAM Reporte  Almcmov.usuario AT 18 "JEFE ALMACEN         "  AT 75 SKIP.
  PUT STREAM Reporte " ** ALMACEN ** " AT 121 SKIP.
  OUTPUT STREAM Reporte CLOSE.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ENDIF

&IF DEFINED(EXCLUDE-Formato-1-RB) = 0 &THEN

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE Formato-1-RB Procedure 
PROCEDURE Formato-1-RB :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
  
  DEFINE VAR l-ubica AS LOG.

  l-ubica = YES.
  /*Cargando en el temporal del sistema*/
  REPEAT WHILE L-Ubica:
     s-task-no = RANDOM(900000,999999).
     FIND FIRST integral.w-report WHERE integral.w-report.task-no = s-task-no NO-LOCK NO-ERROR.
     IF NOT AVAILABLE integral.w-report THEN L-Ubica = NO.
  END.


  DEF VAR x-ImpMn1 AS DEC NO-UNDO.
  
  FIND FIRST Almdmov WHERE Almdmov.CodCia = Almcmov.CodCia AND
             Almdmov.CodAlm = Almcmov.CodAlm AND
             Almdmov.TipMov = Almcmov.TipMov AND
             Almdmov.CodMov = Almcmov.CodMov AND
             Almdmov.NroDoc = Almcmov.NroDoc USE-INDEX Almd01 NO-LOCK NO-ERROR.
  IF AVAILABLE Almdmov THEN DO:
     REPEAT WHILE  AVAILABLE  AlmDMov      AND Almdmov.CodAlm = Almcmov.CodAlm AND
           Almdmov.TipMov = Almcmov.TipMov AND Almdmov.CodMov = Almcmov.CodMov AND
           Almdmov.NroDoc = Almcmov.NroDoc:
           FIND Almmmatg WHERE Almmmatg.CodCia = Almdmov.CodCia AND
                Almmmatg.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.
           FIND Almmmate WHERE Almmmate.Codcia = Almdmov.CodCia AND
                Almmmate.CodAlm = S-CODALM AND
                Almmmate.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.

           CREATE b-w-report.
                ASSIGN b-w-report.task-no = s-task-no
                        b-w-report.llave-C = "ADMINISTRACION"
                        b-w-report.campo-c[1] = S-CODALM + " - " + lNomAlm
                        b-w-report.campo-c[2] = "INGRESO No. : " + string(Almcmov.NroDoc)
                        b-w-report.campo-c[3] = S-Movimiento
                        b-w-report.campo-c[4] = S-PROCEDENCIA
                        b-w-report.campo-c[5] = S-RUC
                        b-w-report.campo-c[6] = "Fecha : " + string(Almcmov.FchDoc,"99/99/9999")
                        b-w-report.campo-c[7] = S-Referencia3 + " : " + Almcmov.NroRf3
                        b-w-report.campo-c[8] = "Almacen Ingreso : " + S-CODALM
                        b-w-report.campo-c[9] = "Hora  : " + Almcmov.HorRcp
                        b-w-report.campo-c[10] = S-Referencia1 + " : " + Almcmov.NroRf1
                        b-w-report.campo-c[11] = S-MONEDA
                        b-w-report.campo-c[12] = "Tpo.Cam : " + string(Almdmov.TpoCmb,">>9.9999")
                        b-w-report.campo-c[13] = "Observaciones : " + Almcmov.Observ
                        b-w-report.campo-c[14] = "Responsable : " + S-Encargado
                        b-w-report.campo-c[15] = Almdmov.CodMat
                        b-w-report.campo-f[1] = Almdmov.CanDes 
                        b-w-report.campo-c[16] = Almdmov.CodUnd 
                        b-w-report.campo-c[17] = Almmmatg.ArtPro 
                        b-w-report.campo-c[18] = Almmmatg.DesMat 
                        b-w-report.campo-c[19] = Almmmatg.Desmar
                        b-w-report.campo-c[20] = Almmmatg.CatConta[1]
                        b-w-report.campo-c[21] = Almmmate.CodUbi
                        b-w-report.campo-c[22] = Almcmov.usuario.

           FIND NEXT Almdmov USE-INDEX Almd01. 
     END.

     IF x-impresora-destino = 2 THEN DO:
         /* Tinta/Laser */
        RUN imprimir-tinta-laser("alm\RBALM.PRL","entradas almacen - alm",s-task-no).
     END.
     ELSE DO:
         DEFINE VAR x-file-pdf AS CHAR.

         RUN lib/imprimir-directo-pdf(INPUT "alm\RBALM.PRL", 
                                      INPUT "entradas almacen - alm", 
                                      INPUT "w-report.task-no = " + STRING(s-task-no), 
                                      INPUT x-ruta-file-pdf, 
                                      OUTPUT x-file-pdf).
     END.

     /* Borrar */
     DEF BUFFER r-w-report FOR w-report.
     DEFINE VAR lRowId AS ROWID.

     FOR EACH w-report WHERE w-report.task-no = s-task-no NO-LOCK:
         lRowId = ROWID(w-report).
         FIND FIRST r-w-report WHERE ROWID(r-w-report) = lRowid EXCLUSIVE NO-ERROR.
         IF AVAILABLE r-w-report THEN DO:
             DELETE r-w-report.           
         END.    
     END.
     RELEASE r-w-report.

  END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ENDIF

&IF DEFINED(EXCLUDE-Formato-2) = 0 &THEN

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE Formato-2 Procedure 
PROCEDURE Formato-2 :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/

  DEFINE FRAME F-FMT
         Almmmatg.Artpro FORMAT "X(10)"         
         Almdmov.CodMat     AT  11 FORMAT "X(6)"
         Almdmov.CanDes     AT  18 FORMAT ">>>,>>9.9999" 
         Almdmov.CodUnd     AT  31 FORMAT "X(4)" 
         Almmmatg.DesMat    AT  36 FORMAT "X(34)"
         Almmmatg.Desmar    AT  71 FORMAT "X(10)"
         Almmmatg.CatConta[1] AT 82 FORMAT "X(3)"
         Almdmov.Prelis     AT  86 FORMAT ">,>>>.9999"
         Almdmov.Dsctos[1]  AT  98 FORMAT ">>.99"
         Almdmov.Dsctos[2]  AT 104 FORMAT ">>.99"
         Almdmov.Dsctos[3]  AT 110 FORMAT ">>.99"  
         Almdmov.Igvmat     AT 117 FORMAT ">>.99" 
         S-SUBTO            AT 123 FORMAT ">,>>>,>>9.99"
         HEADER
         {&PRN7A} + {&PRN6A} + S-NOMCIA + {&PRN7B} + {&PRN6B} FORMAT "X(45)" SKIP
         "( " + S-CODALM + " - " + lNomAlm + " )" AT 1 FORMAT "X(60)" 
         "INGRESO No. : " AT 96 Almcmov.NroDoc AT 114 SKIP
         /*"( " + S-CODALM + " )" AT 5 FORMAT "X(20)" */
         S-Movimiento  AT 52  "Pag. " AT 108 PAGE-NUMBER(REPORTE) FORMAT ">>9" SKIP(1)
         S-PROCEDENCIA AT 1 FORMAT "X(70)" S-RUC AT 79 "Fecha : " AT 113 Almcmov.FchDoc AT 121 SKIP
         S-Referencia3 AT 1 ": " Almcmov.NroRf3  AT 20 "Almacen Ingreso : " AT 79 S-CODALM AT 99       "Hora  : " AT 113 Almcmov.HorRcp AT 121 SKIP 
         S-Referencia1 AT 1 ": " Almcmov.NroRf1  AT 20 S-MONEDA AT 79 SKIP
         "Observaciones    : " AT 1 Almcmov.Observ  AT 20 "Responsable     : " AT 79 S-Encargado AT 99 SKIP
         "-------------------------------------------------------------------------------------------------------------------------------------" SKIP
         "Cod.Pro. CODIGO  CANTIDAD     UND.         DESCRIPCION                  MARCA    CC VALOR VENTA DSCT1 DSCT2 DSCT3  I.G.V.   TOTAL NETO" SKIP
         "--------------------------------------------------------------------------------------------------------------------------------------" SKIP        
        /*         1         2         3         4         5         6         7         8         9        10        11        12        13 */
        /*1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890 */
        /*1234567890123456 >>>,>>9.9999 1234 1234567890123456789012345678901234 1234567890 123 >,>>>.9999  >>.99 >>.99 >>.99  >>.99 >,>>>,>>9.99 */
         WITH NO-LABEL NO-UNDERLINE NO-BOX WIDTH 145 STREAM-IO DOWN.         
         
  OUTPUT STREAM Reporte TO PRINTER PAGED PAGE-SIZE 30.
  FIND FIRST Almdmov WHERE Almdmov.CodCia = Almcmov.CodCia AND
             Almdmov.CodAlm = Almcmov.CodAlm AND
             Almdmov.TipMov = Almcmov.TipMov AND
             Almdmov.CodMov = Almcmov.CodMov AND
             Almdmov.NroDoc = Almcmov.NroDoc USE-INDEX Almd01 NO-LOCK NO-ERROR.
  IF AVAILABLE Almdmov THEN DO:  
      S-TOTAL = 0.
     PUT STREAM Reporte CONTROL {&PRN0} + {&PRN5A} + CHR(33) + {&PRN3}.     
     REPEAT WHILE  AVAILABLE  AlmDMov      AND Almdmov.CodAlm = Almcmov.CodAlm AND
            Almdmov.TipMov = Almcmov.TipMov AND Almdmov.CodMov = Almcmov.CodMov AND
            Almdmov.NroDoc = Almcmov.NroDoc:
            FIND Almmmatg WHERE Almmmatg.CodCia = Almdmov.CodCia AND
                 Almmmatg.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.
            W-VTA0 = almdmov.prelis * (1 - (Almdmov.dsctos[1] / 100)).
            W-VTA1 = w-vta0  * (1 - (Almdmov.dsctos[2] / 100)).
            W-VTA2 = w-vta1  * (1 - (Almdmov.dsctos[3] / 100)).
            IF Almmmatg.AftIgv THEN    
                S-SUBTO = ROUND(( W-VTA2 + ( W-VTA2 * (Almdmov.IgvMat / 100 ))) * ALMDMOV.CANDES,2).
            ELSE 
                S-SUBTO = ROUND( W-VTA2  * ALMDMOV.CANDES,2).
            S-TOTAL = S-TOTAL + S-SUBTO.
            DISPLAY STREAM Reporte 
                    Almdmov.CodMat 
                    Almdmov.CanDes 
                    Almdmov.CodUnd 
                    Almmmatg.ArtPro 
                    Almmmatg.DesMat 
                    Almmmatg.Desmar
                    Almmmatg.CaTConta[1]
                    Almdmov.Prelis  
                    Almdmov.Dsctos[1]
                    Almdmov.Dsctos[2]
                    Almdmov.Dsctos[3]
                    Almdmov.Igvmat
                    S-SUBTO WITH FRAME F-FMT.
            DOWN STREAM Reporte WITH FRAME F-FMT.
            FIND NEXT Almdmov USE-INDEX Almd01.
     END.
     PUT STREAM Reporte "------------" AT 123 skip.
     PUT STREAM Reporte S-MON AT 118 S-TOTAL FORMAT ">,>>>,>>9.99" AT 123 SKIP.
  END.
  DO WHILE LINE-COUNTER(Reporte) < PAGE-SIZE(Reporte) - 4 :
     PUT STREAM Reporte "" skip.
  END.
  PUT STREAM Reporte "    -----------------       -----------------       -----------------      -----------------"  AT 10 SKIP.
  PUT STREAM Reporte "        Operador                 Vo. Bo.                  Vo. Bo.               Vo. Bo.     "  AT 10 SKIP.
  PUT STREAM Reporte Almcmov.usuario AT 18 "JEFE ALMACEN             CONTABILIDAD            GERENCIA     "  AT 40 SKIP.
  PUT STREAM Reporte " ** TESORERIA ** " AT 119 SKIP.
  OUTPUT STREAM Reporte CLOSE.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ENDIF

&IF DEFINED(EXCLUDE-Formato-3) = 0 &THEN

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE Formato-3 Procedure 
PROCEDURE Formato-3 :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/

  DEFINE FRAME F-FMT
         Almmmatg.Artpro FORMAT "X(10)"         
         Almdmov.CodMat     AT  11 FORMAT "X(6)"
         Almdmov.CanDes     AT  18 FORMAT ">>>,>>9.9999" 
         Almdmov.CodUnd     AT  31 FORMAT "X(4)" 
         Almmmatg.DesMat    AT  36 FORMAT "X(34)"
         Almmmatg.Desmar    AT  71 FORMAT "X(10)"
         Almdmov.Prelis     AT  83 FORMAT ">,>>>.9999"
         Almdmov.Dsctos[1]  AT  95 FORMAT ">>.99"
         Almdmov.Dsctos[2]  AT 101 FORMAT ">>.99"
         Almdmov.Dsctos[3]  AT 107 FORMAT ">>.99"  
         Almdmov.Igvmat     AT 114 FORMAT ">>.99" 
/*       Almdmov.ImpCto     AT 120 FORMAT ">,>>>,>>9.99"*/
         S-SUBTO            AT 120 FORMAT ">,>>>,>>9.99"
         HEADER
         S-NOMCIA FORMAT "X(45)" 
         "SALIDA  No. : " AT 96 Almcmov.NroDoc AT 114 SKIP
         /*"( " + S-CODALM + " )"  AT 5 FORMAT "X(20)" */
         "( " + S-CODALM + " - " + lNomAlm + " )" AT 1 FORMAT "X(60)" 
         S-Movimiento  AT 52  "Pag. " AT 108 PAGE-NUMBER(REPORTE) FORMAT ">>9" SKIP(1)
         S-PROCEDENCIA AT 1 FORMAT "X(70)" S-RUC AT 79 "Fecha : " AT 113 Almcmov.FchDoc AT 121 SKIP
/*          S-Referencia2 AT 1 ": " Almcmov.NroRf2  AT 20 "Almacen Ingreso : " AT 79 S-CODALM AT 99       "Hora  : " AT 113 Almcmov.HorRcp AT 121 SKIP */
         S-Referencia3 AT 1 ": " Almcmov.NroRf3  AT 20 "Almacen Ingreso : " AT 79 S-CODALM AT 99       "Hora  : " AT 113 Almcmov.HorRcp AT 121 SKIP 
         S-Referencia1 AT 1 ": " Almcmov.NroRf1  AT 20 S-MONEDA AT 79 SKIP
         "Observaciones    : " AT 1 Almcmov.Observ  AT 20 "Responsable     : " AT 79 S-Encargado AT 99 SKIP
         "-----------------------------------------------------------------------------------------------------------------------------------" SKIP
         "Cod.Pro. CODIGO  CANTIDAD     UND.         DESCRIPCION                  MARCA    VALOR VENTA DSCT1 DSCT2 DSCT3  I.G.V.   TOTAL NETO" SKIP
         "-----------------------------------------------------------------------------------------------------------------------------------" SKIP        
        /*         1         2         3         4         5         6         7         8         9        10        11        12        13 */
        /*1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890 */
        /*1234567890123456 >>>,>>9.9999 1234 1234567890123456789012345678901234 1234567890 123 >,>>>.9999  >>.99 >>.99 >>.99  >>.99 >,>>>,>>9.99 */
         WITH NO-LABEL NO-UNDERLINE NO-BOX WIDTH 145 STREAM-IO DOWN.         
         
  OUTPUT STREAM Reporte TO PRINTER PAGED PAGE-SIZE 30.
  FIND FIRST Almdmov WHERE Almdmov.CodCia = Almcmov.CodCia AND
             Almdmov.CodAlm = Almcmov.CodAlm AND
             Almdmov.TipMov = Almcmov.TipMov AND
             Almdmov.CodMov = Almcmov.CodMov AND
             Almdmov.NroDoc = Almcmov.NroDoc USE-INDEX Almd01 NO-LOCK NO-ERROR.
  IF AVAILABLE Almdmov THEN DO:  
     PUT STREAM Reporte CONTROL {&PRN0} + {&PRN5A} + CHR(33) + {&PRN3}.     
     REPEAT WHILE  AVAILABLE  AlmDMov      AND Almdmov.CodAlm = Almcmov.CodAlm AND
           Almdmov.TipMov = Almcmov.TipMov AND Almdmov.CodMov = Almcmov.CodMov AND
           Almdmov.NroDoc = Almcmov.NroDoc:
           FIND Almmmatg WHERE Almmmatg.CodCia = Almdmov.CodCia AND
                Almmmatg.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.
/*              S-TOTAL = S-TOTAL + Almdmov.ImpCto.*/                
                W-VTA0 = almdmov.prelis * (1 - (Almdmov.dsctos[1] / 100)).
                W-VTA1 = w-vta0  * (1 - (Almdmov.dsctos[2] / 100)).
                W-VTA2 = w-vta1  * (1 - (Almdmov.dsctos[3] / 100)).
                S-SUBTO = ROUND(( W-VTA2 + ( W-VTA2 * (Almdmov.IgvMat / 100 ))) * ALMDMOV.CANDES,2).
                S-TOTAL = S-TOTAL + S-SUBTO.

           DISPLAY STREAM Reporte 
                   Almdmov.CodMat 
                   Almdmov.CanDes 
                   Almdmov.CodUnd 
                   Almmmatg.ArtPro 
                   Almmmatg.DesMat 
                   Almmmatg.Desmar
                   Almdmov.Prelis  
                   Almdmov.Dsctos[1]
                   Almdmov.Dsctos[2]
                   Almdmov.Dsctos[3]
                   Almdmov.Igvmat
/*                 Almdmov.ImpCto */
                   S-SUBTO WITH FRAME F-FMT.
           DOWN STREAM Reporte WITH FRAME F-FMT.
           FIND NEXT Almdmov USE-INDEX Almd01.
     END.
     PUT STREAM Reporte "------------" AT 120 skip.
     PUT STREAM Reporte S-MON AT 115 S-TOTAL FORMAT ">,>>>,>>9.99" AT 120 SKIP.
  END.
  DO WHILE LINE-COUNTER(Reporte) < PAGE-SIZE(Reporte) - 4 :
     PUT STREAM Reporte "" skip.
  END.
  PUT STREAM Reporte "    -----------------       -----------------       -----------------      -----------------"  AT 10 SKIP.
  PUT STREAM Reporte "        Operador                 Vo. Bo.                  Vo. Bo.               Vo. Bo.     "  AT 10 SKIP.
  PUT STREAM Reporte Almcmov.usuario AT 18 "JEFE ALMACEN             CONTABILIDAD            GERENCIA     "  AT 40 SKIP.
  PUT STREAM Reporte " ** TESORERIA ** " AT 119 SKIP.
  OUTPUT STREAM Reporte CLOSE.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ENDIF

&IF DEFINED(EXCLUDE-Formato-4) = 0 &THEN

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE Formato-4 Procedure 
PROCEDURE Formato-4 :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
  DEFINE FRAME F-FMT
         S-Item             AT  1   FORMAT "ZZ9"
         Almdmov.CodMat     AT  6   FORMAT "X(6)"
         Almmmatg.DesMat    AT  14  FORMAT "X(50)"
         Almmmatg.Desmar    AT  65  FORMAT "X(15)"
         Almdmov.CodUnd     AT  82  FORMAT "X(4)"          
         Almmmatg.CanEmp    AT  88  FORMAT ">>,>>9.99"
         Almdmov.CanDes     AT  99  FORMAT ">>>,>>9.9999" 
         "__________"       AT  111  
         Almmmate.CodUbi    AT  125 FORMAT "X(6)"
         HEADER
         S-NOMCIA FORMAT "X(45)" SKIP
         "( " + S-DESALM + " )" FORMAT "X(50)" 
         S-Movimiento  AT 52  /*"Pag. " AT 108 PAGE-NUMBER(REPORTE) FORMAT ">>9"*/ SKIP
         "( PRE - DESPACHO )" AT 58 SKIP
         "Nro Documento : " AT 105 Almcmov.Nroser AT 121 "-" AT 124 Almcmov.NroDoc AT 125 SKIP         
         S-PROCEDENCIA AT 1 FORMAT "X(70)" 
         "Fecha : " AT 113 Almcmov.FchDoc AT 121 SKIP
         S-Referencia1 AT 1 ": " Almcmov.NroRf1  AT 20 
         "Almacen Salida  : " AT 79 S-CODALM AT 99       
         "Hora  : " AT 113 Almcmov.HorRcp AT 121 SKIP 
         "Observaciones    : " AT 1 Almcmov.Observ  AT 20 "Responsable     : " AT 79 S-Encargado AT 99 SKIP
         "-----------------------------------------------------------------------------------------------------------------------------------" SKIP
         "ITEM CODIGO                DESCRIPCION                             M A R C A     UND.    EMPAQUE    CANTIDAD  DESPACHADO  UBICACION" SKIP
         "-----------------------------------------------------------------------------------------------------------------------------------" SKIP
/*           99  999999 12345678901234567890123456789012345678901234567890 123456789012345  81                                       
               6      13                                                  65 */
         WITH NO-LABEL NO-UNDERLINE NO-BOX WIDTH 145 STREAM-IO DOWN.         
         
  OUTPUT STREAM Reporte TO PRINTER PAGED PAGE-SIZE 30.
  FIND FIRST Almdmov WHERE Almdmov.CodCia = Almcmov.CodCia AND
             Almdmov.CodAlm = Almcmov.CodAlm AND
             Almdmov.TipMov = Almcmov.TipMov AND
             Almdmov.CodMov = Almcmov.CodMov AND
             Almdmov.NroDoc = Almcmov.NroDoc USE-INDEX Almd01 NO-LOCK NO-ERROR.
  IF AVAILABLE Almdmov THEN DO:
     PUT STREAM Reporte CONTROL {&PRN0} + {&PRN5A} + CHR(33) + {&PRN3}.     
     REPEAT WHILE  AVAILABLE  AlmDMov      AND Almdmov.CodAlm = Almcmov.CodAlm AND
           Almdmov.TipMov = Almcmov.TipMov AND Almdmov.CodMov = Almcmov.CodMov AND
           Almdmov.NroDoc = Almcmov.NroDoc:
           FIND Almmmatg WHERE Almmmatg.CodCia = Almdmov.CodCia AND
                Almmmatg.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.
           FIND Almmmate WHERE Almmmate.Codcia = Almdmov.CodCia AND
                Almmmate.CodAlm = S-CODALM AND
                Almmmate.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.
           S-Item = S-Item + 1.     
           DISPLAY STREAM Reporte 
                   S-Item 
                   Almdmov.CodMat 
                   Almdmov.CanDes 
                   Almdmov.CodUnd 
                   Almmmatg.ArtPro 
                   Almmmatg.DesMat 
                   Almmmatg.CanEmp
                   Almmmate.CodUbi
                   Almmmatg.Desmar WITH FRAME F-FMT.
           DOWN STREAM Reporte WITH FRAME F-FMT.
           FIND NEXT Almdmov USE-INDEX Almd01.
     END.
  END.
  DO WHILE LINE-COUNTER(Reporte) < PAGE-SIZE(Reporte) - 4 :
     PUT STREAM Reporte "" skip.
  END.
  PUT STREAM Reporte "    -----------------            -----------------             -----------------       "  AT 10 SKIP.
  PUT STREAM Reporte "        Operador                    Despachador                     Vo. Bo.            "  AT 10 SKIP.
  PUT STREAM Reporte  Almcmov.usuario AT 18 "JEFE ALMACEN         "  AT 75 SKIP.
  PUT STREAM Reporte " ** ALMACEN ** " AT 121 SKIP.
  OUTPUT STREAM Reporte CLOSE.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ENDIF

&IF DEFINED(EXCLUDE-Formato-C) = 0 &THEN

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE Formato-C Procedure 
PROCEDURE Formato-C :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
  DEF VAR x-ImpMn1 AS DEC NO-UNDO.
  
  S-TOTAL = 0.
  DEFINE VAR F-MONEDA AS CHAR FORMAT "X(4)".
  
  DEFINE FRAME F-FMT
         Almmmatg.Artpro FORMAT "X(09)"
         Almdmov.CodMat     FORMAT "X(6)"
         Almdmov.CanDes     FORMAT ">>>,>>9.9999" 
         Almdmov.CodUnd     FORMAT "X(4)" 
         Almmmatg.DesMat    FORMAT "X(45)"
         Almmmatg.Desmar    FORMAT "X(20)"
         Almmmatg.CatConta[1] FORMAT 'X(3)'
         F-MONEDA           FORMAT "X(4)" 
         Almdmov.Prelis     FORMAT ">>,>>>.9999"
         x-ImpMn1           FORMAT ">,>>>,>>9.99"
         HEADER
         {&PRN7A} + {&PRN6A} + S-NOMCIA + {&PRN7B} + {&PRN6B} FORMAT "X(45)" SKIP
         "( " + S-CODALM + " - " + lNomAlm + " )" AT 1 FORMAT "X(60)" 
         "INGRESO No. : " AT 96 Almcmov.NroDoc AT 114 SKIP
         /*"( " + S-CODALM + " )" AT 5 FORMAT "X(20)" */
         S-Movimiento  AT 52  "Pag. " AT 108 PAGE-NUMBER(Reporte) FORMAT ">>9" SKIP(1)
         S-PROCEDENCIA AT 1 FORMAT "X(70)" S-RUC AT 79 "Fecha : " AT 113 Almcmov.FchDoc AT 121 SKIP
         S-Referencia3 AT 1 ": " Almcmov.NroRf3  AT 20 "Almacen Ingreso : " AT 79 S-CODALM AT 99 "Hora  : " AT 113 Almcmov.HorRcp AT 121 SKIP 
         S-Referencia1 AT 1 ": " Almcmov.NroRf1  AT 20 S-MONEDA AT 79  "Tpo.Cam : " AT 113 Almdmov.TpoCmb AT 123 FORMAT ">>9.9999" SKIP
         "Observaciones    : " AT 1 Almcmov.Observ  AT 20 "Responsable     : " AT 79 S-Encargado AT 99 SKIP
         "---------------------------------------------------------------------------------------------------------------------------------------" SKIP
         "Cod.Pro.  CODIGO  CANTIDAD    UND.            DESCRIPCION                        M A R C A            CC  MON  VALOR VENTA  IMPORTE S/." SKIP
         "---------------------------------------------------------------------------------------------------------------------------------------" SKIP
        /*         1         2         3         4         5         6         7         8         9        10        11        12        13*/
        /*1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890*/
        /*123456789 123456 >>>,>>9.9999 1234 123456789012345678901234567890123456789012345 12345678901234567890 123 123 >>,>>>.9999 >,>>>,>>9.99 */
         WITH NO-LABEL NO-UNDERLINE NO-BOX WIDTH 145 STREAM-IO DOWN.

  OUTPUT STREAM Reporte TO PRINTER PAGED PAGE-SIZE 30.
  FIND FIRST Almdmov WHERE Almdmov.CodCia = Almcmov.CodCia AND
                           Almdmov.CodAlm = Almcmov.CodAlm AND
                           Almdmov.TipMov = Almcmov.TipMov AND
                           Almdmov.CodMov = Almcmov.CodMov AND
                           Almdmov.NroDoc = Almcmov.NroDoc USE-INDEX Almd01 NO-LOCK NO-ERROR.

  IF AVAILABLE Almdmov THEN DO:  
     PUT STREAM Reporte CONTROL {&PRN0} + {&PRN5A} + CHR(33) + {&PRN3}.  
     REPEAT WHILE  AVAILABLE  AlmDMov AND 
                   Almdmov.CodAlm = Almcmov.CodAlm AND
                   Almdmov.TipMov = Almcmov.TipMov AND 
                   Almdmov.CodMov = Almcmov.CodMov AND
                   Almdmov.NroDoc = Almcmov.NroDoc:

           FIND FIRST Almmmatg WHERE Almmmatg.CodCia = Almdmov.CodCia AND
                      Almmmatg.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.
            
           IF Almdmov.codmon = 1
           THEN x-ImpMn1 = Almdmov.ImpCto.
           ELSE x-ImpMn1 = Almdmov.ImpCto * Almdmov.TpoCmb.
           
           S-TOTAL = S-TOTAL + x-ImpMn1.        /*Almdmov.ImpMn1.*/
            
           IF ALMDMOV.CODMON = 1 THEN F-MONEDA = "S/.".
           ELSE F-MONEDA = "US$.".                 
           DISPLAY stream Reporte
                   Almdmov.CodMat 
                   Almdmov.CanDes 
                   Almdmov.CodUnd 
                   Almmmatg.ArtPro 
                   Almmmatg.DesMat 
                   Almmmatg.Desmar
                   Almmmatg.CatConta[1]
                   F-MONEDA
                   Almdmov.Prelis
                   /*Almdmov.ImpMn1*/
                   x-ImpMn1
                   WITH FRAME F-FMT.
           FIND NEXT Almdmov USE-INDEX Almd01.
     END.
     PUT STREAM Reporte "------------" AT 120 skip.
     PUT STREAM Reporte S-TOTAL FORMAT ">,>>>,>>9.99" AT 120 SKIP.     
  END.
  DO WHILE LINE-COUNTER(Reporte) < PAGE-SIZE(Reporte) - 6 :
     PUT STREAM Reporte "" skip.
  END.
  PUT STREAM Reporte "    -----------------       -----------------       -----------------      -----------------"  AT 10 SKIP.
  PUT STREAM Reporte "        Operador                 Vo. Bo.                  Vo. Bo.               Vo. Bo.     "  AT 10 SKIP.
  PUT STREAM Reporte Almcmov.usuario AT 18 "JEFE ALMACEN             CONTABILIDAD            GERENCIA     "  AT 40 SKIP.
  /*PUT STREAM Reporte " ** CONTABILIDAD ** " AT 119 SKIP.*/
  PUT STREAM Reporte " ** ADMINISTRACION ** " AT 110 SKIP.

  OUTPUT STREAM Reporte CLOSE.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ENDIF

&IF DEFINED(EXCLUDE-Formato-C-RB) = 0 &THEN

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE Formato-C-RB Procedure 
PROCEDURE Formato-C-RB :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
    DEFINE VAR l-ubica AS LOG.

    l-ubica = YES.
    /*Cargando en el temporal del sistema*/
    REPEAT WHILE L-Ubica:
       s-task-no = RANDOM(900000,999999).
       FIND FIRST integral.w-report WHERE integral.w-report.task-no = s-task-no NO-LOCK NO-ERROR.
       IF NOT AVAILABLE integral.w-report THEN L-Ubica = NO.
    END.


  DEF VAR x-ImpMn1 AS DEC NO-UNDO.
  
  S-TOTAL = 0.
  DEFINE VAR F-MONEDA AS CHAR FORMAT "X(4)".

  FIND FIRST Almdmov WHERE Almdmov.CodCia = Almcmov.CodCia AND
                           Almdmov.CodAlm = Almcmov.CodAlm AND
                           Almdmov.TipMov = Almcmov.TipMov AND
                           Almdmov.CodMov = Almcmov.CodMov AND
                           Almdmov.NroDoc = Almcmov.NroDoc USE-INDEX Almd01 NO-LOCK NO-ERROR.

  IF AVAILABLE Almdmov THEN DO:  
        REPEAT WHILE  AVAILABLE  AlmDMov AND 
                   Almdmov.CodAlm = Almcmov.CodAlm AND
                   Almdmov.TipMov = Almcmov.TipMov AND 
                   Almdmov.CodMov = Almcmov.CodMov AND
                   Almdmov.NroDoc = Almcmov.NroDoc:

           FIND FIRST Almmmatg WHERE Almmmatg.CodCia = Almdmov.CodCia AND
                      Almmmatg.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.
            
           IF Almdmov.codmon = 1
           THEN x-ImpMn1 = Almdmov.ImpCto.
           ELSE x-ImpMn1 = Almdmov.ImpCto * Almdmov.TpoCmb.
           
           S-TOTAL = S-TOTAL + x-ImpMn1.        /*Almdmov.ImpMn1.*/
            
           IF ALMDMOV.CODMON = 1 THEN F-MONEDA = "S/.".
           ELSE F-MONEDA = "US$.".                 

           CREATE b-w-report.
                ASSIGN b-w-report.task-no = s-task-no
                        b-w-report.llave-C = "ADMINISTRACION"
                        b-w-report.campo-c[1] = S-CODALM + " - " + lNomAlm
                        b-w-report.campo-c[2] = "INGRESO No. : " + string(Almcmov.NroDoc)
                        b-w-report.campo-c[3] = S-Movimiento
                        b-w-report.campo-c[4] = S-PROCEDENCIA
                        b-w-report.campo-c[5] = S-RUC
                        b-w-report.campo-c[6] = "Fecha : " + string(Almcmov.FchDoc,"99/99/9999")
                        b-w-report.campo-c[7] = S-Referencia3 + " : " + Almcmov.NroRf3
                        b-w-report.campo-c[8] = "Almacen Ingreso : " + S-CODALM
                        b-w-report.campo-c[9] = "Hora  : " + Almcmov.HorRcp
                        b-w-report.campo-c[10] = S-Referencia1 + " : " + Almcmov.NroRf1
                        b-w-report.campo-c[11] = S-MONEDA
                        b-w-report.campo-c[12] = "Tpo.Cam : " + string(Almdmov.TpoCmb,">>9.9999")
                        b-w-report.campo-c[13] = "Observaciones : " + Almcmov.Observ
                        b-w-report.campo-c[14] = "Responsable : " + S-Encargado
                        b-w-report.campo-c[15] = Almdmov.CodMat
                        b-w-report.campo-f[1] = Almdmov.CanDes 
                        b-w-report.campo-c[16] = Almdmov.CodUnd 
                        b-w-report.campo-c[17] = Almmmatg.ArtPro 
                        b-w-report.campo-c[18] = Almmmatg.DesMat 
                        b-w-report.campo-c[19] = Almmmatg.Desmar
                        b-w-report.campo-c[20] = Almmmatg.CatConta[1]
                        b-w-report.campo-c[21] = F-MONEDA
                        b-w-report.campo-f[2] = Almdmov.Prelis
                        b-w-report.campo-f[3] = x-ImpMn1
                        b-w-report.campo-c[22] = Almcmov.usuario
            .
           FIND NEXT Almdmov USE-INDEX Almd01.
     END.

     IF x-impresora-destino = 2 THEN DO:
         /* Tinta/Laser */
        RUN imprimir-tinta-laser("alm\RBALM.PRL","entradas almacen - adm",s-task-no).
     END.
     ELSE DO:
         DEFINE VAR x-file-pdf AS CHAR.

         RUN lib/imprimir-directo-pdf(INPUT "alm\RBALM.PRL", 
                                      INPUT "entradas almacen - adm", 
                                      INPUT "w-report.task-no = " + STRING(s-task-no), 
                                      INPUT x-ruta-file-pdf, 
                                      OUTPUT x-file-pdf).
     END.


     /* Borrar */
     DEF BUFFER r-w-report FOR w-report.
     DEFINE VAR lRowId AS ROWID.

     FOR EACH w-report WHERE w-report.task-no = s-task-no NO-LOCK:
         lRowId = ROWID(w-report).
         FIND FIRST r-w-report WHERE ROWID(r-w-report) = lRowid EXCLUSIVE NO-ERROR.
         IF AVAILABLE r-w-report THEN DO:
             DELETE r-w-report.           
         END.    
     END.
     RELEASE r-w-report.

  END.


END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ENDIF

&IF DEFINED(EXCLUDE-Formato-P) = 0 &THEN

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE Formato-P Procedure 
PROCEDURE Formato-P :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/

  DEFINE FRAME F-FMT
         Almmmatg.Artpro FORMAT "X(10)"         
         Almdmov.CodMat     AT  11 FORMAT "X(6)"
         Almdmov.CanDes     AT  18 FORMAT ">>>,>>9.9999" 
         Almdmov.CodUnd     AT  31 FORMAT "X(4)" 
         Almmmatg.DesMat    AT  36 FORMAT "X(34)"
         Almmmatg.Desmar    AT  71 FORMAT "X(10)"
         Almmmatg.CatConta[1] AT 82 FORMAT "X(3)"
         Almdmov.Prelis     AT  86 FORMAT ">,>>>.9999"
         Almdmov.Dsctos[1]  AT  98 FORMAT ">>.99"
         Almdmov.Dsctos[2]  AT 104 FORMAT ">>.99"
         Almdmov.Dsctos[3]  AT 110 FORMAT ">>.99"  
         Almdmov.Igvmat     AT 117 FORMAT ">>.99" 
         S-SUBTO            AT 123 FORMAT ">,>>>,>>9.99"
         HEADER
         {&PRN7A} + {&PRN6A} + S-NOMCIA + {&PRN7B} + {&PRN6B} FORMAT "X(45)" SKIP
         "( " + S-CODALM + " - " + lNomAlm + " )" AT 1 FORMAT "X(60)" 
         "INGRESO No. : " AT 96 Almcmov.NroDoc AT 114 SKIP
         /*"( " + S-CODALM + " )" AT 5 FORMAT "X(20)" */
         S-Movimiento  AT 52  "Pag. " AT 108 PAGE-NUMBER(REPORTE) FORMAT ">>9" SKIP(1)
         S-PROCEDENCIA AT 1 FORMAT "X(70)" S-RUC AT 79 "Fecha : " AT 113 Almcmov.FchDoc AT 121 SKIP
         S-Referencia3 AT 1 ": " Almcmov.NroRf3  AT 20 "Almacen Ingreso : " AT 79 S-CODALM AT 99       "Hora  : " AT 113 Almcmov.HorRcp AT 121 SKIP 
         S-Referencia1 AT 1 ": " Almcmov.NroRf1  AT 20 S-MONEDA AT 79 SKIP
         "Observaciones    : " AT 1 Almcmov.Observ  AT 20 "Responsable     : " AT 79 S-Encargado AT 99 SKIP
         "-------------------------------------------------------------------------------------------------------------------------------------" SKIP
         "Cod.Pro. CODIGO  CANTIDAD  UND.            DESCRIPCION                  MARCA    CC VALOR VENTA DSCT1 DSCT2 DSCT3  I.G.V.   TOTAL NETO" SKIP
         "--------------------------------------------------------------------------------------------------------------------------------------" SKIP        
        /*         1         2         3         4         5         6         7         8         9        10        11        12        13 */
        /*1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890 */
        /*1234567890123456 >>>,>>9.9999 1234 1234567890123456789012345678901234 1234567890 123 >,>>>.9999  >>.99 >>.99 >>.99  >>.99 >,>>>,>>9.99 */
        /*Cod.Pro. CODIGO  CANTIDAD  UND.            DESCRIPCION                  MARCA    CC VALOR VENTA DSCT1 DSCT2 DSCT3  I.G.V.   TOTAL NETO" SKIP */
         WITH NO-LABEL NO-UNDERLINE NO-BOX WIDTH 145 STREAM-IO DOWN.         
         
  OUTPUT STREAM Reporte TO PRINTER PAGED PAGE-SIZE 30.
  FIND FIRST Almdmov WHERE Almdmov.CodCia = Almcmov.CodCia AND
             Almdmov.CodAlm = Almcmov.CodAlm AND
             Almdmov.TipMov = Almcmov.TipMov AND
             Almdmov.CodMov = Almcmov.CodMov AND
             Almdmov.NroDoc = Almcmov.NroDoc USE-INDEX Almd01 NO-LOCK NO-ERROR.
  IF AVAILABLE Almdmov THEN DO:  
      S-TOTAL = 0.
     PUT STREAM Reporte CONTROL {&PRN0} + {&PRN5A} + CHR(33) + {&PRN3}.     
     REPEAT WHILE  AVAILABLE  AlmDMov      AND Almdmov.CodAlm = Almcmov.CodAlm AND
            Almdmov.TipMov = Almcmov.TipMov AND Almdmov.CodMov = Almcmov.CodMov AND
            Almdmov.NroDoc = Almcmov.NroDoc:
            FIND Almmmatg WHERE Almmmatg.CodCia = Almdmov.CodCia AND
                 Almmmatg.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.
            W-VTA0 = almdmov.prelis * (1 - (Almdmov.dsctos[1] / 100)).
            W-VTA1 = w-vta0  * (1 - (Almdmov.dsctos[2] / 100)).
            W-VTA2 = w-vta1  * (1 - (Almdmov.dsctos[3] / 100)).
            IF Almmmatg.AftIgv THEN    
                S-SUBTO = ROUND(( W-VTA2 + ( W-VTA2 * (Almdmov.IgvMat / 100 ))) * ALMDMOV.CANDES,2).
            ELSE 
                S-SUBTO = ROUND( W-VTA2  * ALMDMOV.CANDES,2).
            S-TOTAL = S-TOTAL + S-SUBTO.
            DISPLAY STREAM Reporte 
                    Almdmov.CodMat 
                    Almdmov.CanDes 
                    Almdmov.CodUnd 
                    Almmmatg.ArtPro 
                    Almmmatg.DesMat 
                    Almmmatg.Desmar
                    Almmmatg.CaTConta[1]
                    Almdmov.Prelis  
                    Almdmov.Dsctos[1]
                    Almdmov.Dsctos[2]
                    Almdmov.Dsctos[3]
                    Almdmov.Igvmat
                    S-SUBTO WITH FRAME F-FMT.
            DOWN STREAM Reporte WITH FRAME F-FMT.
            FIND NEXT Almdmov USE-INDEX Almd01.
     END.
     PUT STREAM Reporte "------------" AT 123 skip.
     PUT STREAM Reporte S-MON AT 118 S-TOTAL FORMAT ">,>>>,>>9.99" AT 123 SKIP.
  END.
  DO WHILE LINE-COUNTER(Reporte) < PAGE-SIZE(Reporte) - 4 :
     PUT STREAM Reporte "" skip.
  END.
  PUT STREAM Reporte "    -----------------       -----------------       -----------------      -----------------"  AT 10 SKIP.
  PUT STREAM Reporte "        Operador                 Vo. Bo.                  Vo. Bo.               Vo. Bo.     "  AT 10 SKIP.
  PUT STREAM Reporte Almcmov.usuario AT 18 "JEFE ALMACEN             CONTABILIDAD            GERENCIA     "  AT 40 SKIP.
  PUT STREAM Reporte " ** PROVEEDOR ** " AT 119 SKIP.
  OUTPUT STREAM Reporte CLOSE.

/*   DEFINE FRAME F-FMT                                                                                                                                     */
/*          Almmmatg.ArtPro    FORMAT "X(12)"                                                                                                               */
/*          Almdmov.CodMat     AT  14 FORMAT "X(6)"                                                                                                         */
/*          Almdmov.CanDes     AT  22 FORMAT ">>>,>>9.99"                                                                                                   */
/*          Almdmov.CodUnd     AT  35 FORMAT "X(4)"                                                                                                         */
/*          Almmmatg.DesMat    AT  41 FORMAT "X(50)"                                                                                                        */
/*          Almmmatg.Desmar    AT  91 FORMAT 'x(20)'                                                                                                        */
/*          Almmmatg.CatConta[1] AT 115 FORMAT 'x(3)'                                                                                                       */
/*          Almmmate.CodUbi    AT  124                                                                                                                      */
/*          HEADER                                                                                                                                          */
/*          {&PRN7A} + {&PRN6A} + S-NOMCIA + {&PRN7B} + {&PRN6B} FORMAT "X(45)" SKIP                                                                        */
/*          "INGRESO No. : " AT 96 Almcmov.NroDoc AT 114 SKIP                                                                                               */
/*          "( " + S-CODALM + " )" AT 5 FORMAT "X(20)"                                                                                                      */
/*          S-Movimiento  AT 52 "Pag. " AT 108 PAGE-NUMBER(REPORTE) FORMAT ">>9" SKIP(1)                                                                    */
/*          S-PROCEDENCIA AT 1 FORMAT "X(70)" S-RUC AT 79 "Fecha : " AT 113 Almcmov.FchDoc AT 121 SKIP                                                      */
/*          S-Referencia3 AT 1 ": " Almcmov.NroRf3  AT 20 "Almacen Ingreso : " AT 79 S-CODALM AT 99       "Hora  : " AT 113 Almcmov.HorRcp AT 121 SKIP      */
/*          S-Referencia1 AT 1 ": " Almcmov.NroRf1  AT 20 S-MONEDA AT 79 SKIP                                                                               */
/*          "Observaciones    : " AT 1 Almcmov.Observ  AT 20 "Responsable     : " AT 79 S-Encargado AT 99 SKIP                                              */
/*          "-----------------------------------------------------------------------------------------------------------------------------------" SKIP      */
/*          " COD.PROV.   CODIGO    CANTIDAD    UND.                  DESCRIPCION                          M A R C A           CC      UBICACION" SKIP      */
/*          "-----------------------------------------------------------------------------------------------------------------------------------" SKIP      */
/*         /*         1         2         3         4         5         6         7         8         9        10        11        12        13        14*/ */
/*         /*12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890*/ */
/*         /*123456789012 123456  >>>,>>9.99   1234  1234567890123456789012345678901234567890123456789012345678901234567890    123      123 */              */
/*          WITH NO-LABEL NO-UNDERLINE NO-BOX WIDTH 145 STREAM-IO DOWN.                                                                                     */
/*                                                                                                                                                          */
/*   OUTPUT STREAM Reporte TO PRINTER PAGED PAGE-SIZE 31.                                                                                                   */
/*   FIND FIRST Almdmov WHERE Almdmov.CodCia = Almcmov.CodCia AND                                                                                           */
/*              Almdmov.CodAlm = Almcmov.CodAlm AND                                                                                                         */
/*              Almdmov.TipMov = Almcmov.TipMov AND                                                                                                         */
/*              Almdmov.CodMov = Almcmov.CodMov AND                                                                                                         */
/*              Almdmov.NroDoc = Almcmov.NroDoc USE-INDEX Almd01 NO-LOCK NO-ERROR.                                                                          */
/*   IF AVAILABLE Almdmov THEN DO:                                                                                                                          */
/*      PUT STREAM Reporte CONTROL {&PRN0} + {&PRN5A} + CHR(33) + {&PRN3}.                                                                                  */
/*      REPEAT WHILE  AVAILABLE  AlmDMov      AND Almdmov.CodAlm = Almcmov.CodAlm AND                                                                       */
/*            Almdmov.TipMov = Almcmov.TipMov AND Almdmov.CodMov = Almcmov.CodMov AND                                                                       */
/*            Almdmov.NroDoc = Almcmov.NroDoc:                                                                                                              */
/*            FIND Almmmatg WHERE Almmmatg.CodCia = Almdmov.CodCia AND                                                                                      */
/*                 Almmmatg.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.                                                                                       */
/*            FIND Almmmate WHERE Almmmate.Codcia = Almdmov.CodCia AND                                                                                      */
/*                 Almmmate.CodAlm = S-CODALM AND                                                                                                           */
/*                 Almmmate.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.                                                                                       */
/*            DISPLAY STREAM Reporte                                                                                                                        */
/*                    Almdmov.CodMat                                                                                                                        */
/*                    Almdmov.CanDes                                                                                                                        */
/*                    Almdmov.CodUnd                                                                                                                        */
/*                    Almmmatg.ArtPro                                                                                                                       */
/*                    Almmmatg.DesMat                                                                                                                       */
/*                    Almmmate.CodUbi                                                                                                                       */
/*                    Almmmatg.Desmar                                                                                                                       */
/*                    Almmmatg.CatConta[1]                                                                                                                  */
/*                    WITH FRAME F-FMT.                                                                                                                     */
/*            DOWN STREAM Reporte WITH FRAME F-FMT.                                                                                                         */
/*            FIND NEXT Almdmov USE-INDEX Almd01.                                                                                                           */
/*      END.                                                                                                                                                */
/*   END.                                                                                                                                                   */
/*   DO WHILE LINE-COUNTER(Reporte) < PAGE-SIZE(Reporte) - 6 :                                                                                              */
/*      PUT STREAM Reporte "" skip.                                                                                                                         */
/*   END.                                                                                                                                                   */
/*   PUT STREAM Reporte "    -----------------            -----------------            -----------------            ----------------- " AT 10 SKIP.         */
/*   PUT STREAM Reporte "        Operador                      Recibido                      Vo. Bo.                   ADMINISTRADOR  " AT 10 SKIP.         */
/*   PUT STREAM Reporte  Almcmov.usuario AT 18 "JEFE ALMACEN         "  AT 75 SKIP.                                                                         */
/*   PUT STREAM Reporte " ** PROVEEDOR ** " AT 121 SKIP.                                                                                                    */
/*   OUTPUT STREAM Reporte CLOSE.                                                                                                                           */

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ENDIF

&IF DEFINED(EXCLUDE-Formato-P-RB) = 0 &THEN

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE Formato-P-RB Procedure 
PROCEDURE Formato-P-RB :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
  DEFINE VAR l-ubica AS LOG.

  l-ubica = YES.
  /*Cargando en el temporal del sistema*/
  REPEAT WHILE L-Ubica:
     s-task-no = RANDOM(900000,999999).
     FIND FIRST integral.w-report WHERE integral.w-report.task-no = s-task-no NO-LOCK NO-ERROR.
     IF NOT AVAILABLE integral.w-report THEN L-Ubica = NO.
  END.

  DEF VAR x-ImpMn1 AS DEC NO-UNDO.
    
  FIND FIRST Almdmov WHERE Almdmov.CodCia = Almcmov.CodCia AND
             Almdmov.CodAlm = Almcmov.CodAlm AND
             Almdmov.TipMov = Almcmov.TipMov AND
             Almdmov.CodMov = Almcmov.CodMov AND
             Almdmov.NroDoc = Almcmov.NroDoc USE-INDEX Almd01 NO-LOCK NO-ERROR.
  IF AVAILABLE Almdmov THEN DO:  
      S-TOTAL = 0.
     REPEAT WHILE  AVAILABLE  AlmDMov      AND Almdmov.CodAlm = Almcmov.CodAlm AND
            Almdmov.TipMov = Almcmov.TipMov AND Almdmov.CodMov = Almcmov.CodMov AND
            Almdmov.NroDoc = Almcmov.NroDoc:
            FIND Almmmatg WHERE Almmmatg.CodCia = Almdmov.CodCia AND
                 Almmmatg.CodMat = Almdmov.CodMat NO-LOCK NO-ERROR.
            W-VTA0 = almdmov.prelis * (1 - (Almdmov.dsctos[1] / 100)).
            W-VTA1 = w-vta0  * (1 - (Almdmov.dsctos[2] / 100)).
            W-VTA2 = w-vta1  * (1 - (Almdmov.dsctos[3] / 100)).
            IF Almmmatg.AftIgv THEN    
                S-SUBTO = ROUND(( W-VTA2 + ( W-VTA2 * (Almdmov.IgvMat / 100 ))) * ALMDMOV.CANDES,2).
            ELSE 
                S-SUBTO = ROUND( W-VTA2  * ALMDMOV.CANDES,2).
            S-TOTAL = S-TOTAL + S-SUBTO.

            CREATE b-w-report.
                 ASSIGN b-w-report.task-no = s-task-no
                         b-w-report.llave-C = "ADMINISTRACION"
                         b-w-report.campo-c[1] = S-CODALM + " - " + lNomAlm
                         b-w-report.campo-c[2] = "INGRESO No. : " + string(Almcmov.NroDoc)
                         b-w-report.campo-c[3] = S-Movimiento
                         b-w-report.campo-c[4] = S-PROCEDENCIA
                         b-w-report.campo-c[5] = S-RUC
                         b-w-report.campo-c[6] = "Fecha : " + string(Almcmov.FchDoc,"99/99/9999")
                         b-w-report.campo-c[7] = S-Referencia3 + " : " + Almcmov.NroRf3
                         b-w-report.campo-c[8] = "Almacen Ingreso : " + S-CODALM
                         b-w-report.campo-c[9] = "Hora  : " + Almcmov.HorRcp
                         b-w-report.campo-c[10] = S-Referencia1 + " : " + Almcmov.NroRf1
                         b-w-report.campo-c[11] = S-MONEDA
                         b-w-report.campo-c[12] = "Tpo.Cam : " + string(Almdmov.TpoCmb,">>9.9999")
                         b-w-report.campo-c[13] = "Observaciones : " + Almcmov.Observ
                         b-w-report.campo-c[14] = "Responsable : " + S-Encargado
                         b-w-report.campo-c[15] = Almdmov.CodMat
                         b-w-report.campo-f[1] = Almdmov.CanDes 
                         b-w-report.campo-c[16] = Almdmov.CodUnd 
                         b-w-report.campo-c[17] = Almmmatg.ArtPro 
                         b-w-report.campo-c[18] = Almmmatg.DesMat 
                         b-w-report.campo-c[19] = Almmmatg.Desmar
                         b-w-report.campo-c[20] = Almmmatg.CatConta[1]
                         /*b-w-report.campo-c[21] = F-MONEDA*/
                         b-w-report.campo-f[2] = Almdmov.Prelis
                         b-w-report.campo-f[4] = Almdmov.Dsctos[1]
                         b-w-report.campo-f[5] = Almdmov.Dsctos[2]
                         b-w-report.campo-f[6] = Almdmov.Dsctos[3]
                         b-w-report.campo-f[7] = Almdmov.Igvmat
                         b-w-report.campo-f[3] = S-SUBTO
                         b-w-report.campo-c[22] = Almcmov.usuario
            .
            FIND NEXT Almdmov USE-INDEX Almd01.
     END.

     IF x-impresora-destino = 2 THEN DO:
         /* Tinta/Laser */
        RUN imprimir-tinta-laser("alm\RBALM.PRL","entradas almacen - prov",s-task-no).
     END.
     ELSE DO:
         DEFINE VAR x-file-pdf AS CHAR.

         RUN lib/imprimir-directo-pdf(INPUT "alm\RBALM.PRL", 
                                      INPUT "entradas almacen - prov", 
                                      INPUT "w-report.task-no = " + STRING(s-task-no), 
                                      INPUT x-ruta-file-pdf, 
                                      OUTPUT x-file-pdf).
     END.

     /* Borrar */
     DEF BUFFER r-w-report FOR w-report.
     DEFINE VAR lRowId AS ROWID.

     FOR EACH w-report WHERE w-report.task-no = s-task-no NO-LOCK:
         lRowId = ROWID(w-report).
         FIND FIRST r-w-report WHERE ROWID(r-w-report) = lRowid EXCLUSIVE NO-ERROR.
         IF AVAILABLE r-w-report THEN DO:
             DELETE r-w-report.           
         END.    
     END.
     RELEASE r-w-report.

  END.
  /*
  DO WHILE LINE-COUNTER(Reporte) < PAGE-SIZE(Reporte) - 4 :
     PUT STREAM Reporte "" skip.
  END.
  
  PUT STREAM Reporte "    -----------------       -----------------       -----------------      -----------------"  AT 10 SKIP.
  PUT STREAM Reporte "        Operador                 Vo. Bo.                  Vo. Bo.               Vo. Bo.     "  AT 10 SKIP.
  PUT STREAM Reporte Almcmov.usuario AT 18 "JEFE ALMACEN             CONTABILIDAD            GERENCIA     "  AT 40 SKIP.
  PUT STREAM Reporte " ** PROVEEDOR ** " AT 119 SKIP.
  OUTPUT STREAM Reporte CLOSE.
  */

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ENDIF

&IF DEFINED(EXCLUDE-Imprime_FR) = 0 &THEN

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE Imprime_FR Procedure 
PROCEDURE Imprime_FR :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
  FIND almcmov WHERE ROWID(almcmov) = X-Rowid NO-LOCK.
 
  IF almcmov.Codmon = 1 THEN DO:
     S-Moneda = "Compra en       :   SOLES".
     S-Mon    = "S/.".
  END.
  ELSE DO:
     S-Moneda = "Compra en       :   DOLARES".
     S-Mon    = "US$.".
  END.     
       
  FIND FIRST Almtmovm WHERE  Almtmovm.CodCia = Almcmov.CodCia AND
             Almtmovm.Tipmov = Almcmov.TipMov AND 
             Almtmovm.Codmov = Almcmov.CodMov NO-LOCK NO-ERROR.
  IF AVAILABLE Almtmovm THEN DO:
     S-Movimiento = Almcmov.TipMov + STRING(Almcmov.CodMov,"99") + "-" + CAPS(Almtmovm.Desmov).
     IF Almtmovm.PidCli THEN DO:
        FIND gn-clie WHERE gn-clie.CodCia = 0 AND 
             gn-clie.CodCli = Almcmov.CodCli NO-LOCK NO-ERROR.
        IF NOT AVAILABLE gn-clie THEN 
           FIND gn-clie WHERE gn-clie.CodCia = Almcmov.CodCia AND 
                gn-clie.CodCli = Almcmov.CodCli NO-LOCK NO-ERROR.
        IF AVAILABLE gn-clie THEN DO: 
            S-Procedencia = "Cliente          : " + gn-clie.NomCli.
            S-RUC = "R.U.C.          :   " + gn-clie.Ruc.
        END.
        IF S-RUC = "" THEN S-RUC = "R.U.C.          :   " + Almcmov.CodCli.
                                        
     END.
     IF Almtmovm.PidPro THEN DO:
        FIND gn-prov WHERE gn-prov.CodCia = 0 AND 
             gn-prov.CodPro = Almcmov.CodPro NO-LOCK NO-ERROR.
        IF NOT AVAILABLE gn-prov THEN 
          FIND gn-prov WHERE gn-prov.CodCia = Almcmov.CodCia AND 
               gn-prov.CodPro = Almcmov.CodPro NO-LOCK NO-ERROR.
        IF AVAILABLE gn-prov THEN DO: 
            S-Procedencia = "Proveedor        : " + gn-prov.NomPro.
            S-RUC = "R.U.C.          :   " + gn-prov.Ruc.
        END.
        IF S-RUC = "" THEN S-RUC = "R.U.C.          :   " + Almcmov.CodPro.

     END.
     IF Almtmovm.Movtrf THEN DO:
        S-Moneda = "".
        FIND Almacen WHERE Almacen.CodCia = S-CODCIA AND
             Almacen.CodAlm = Almcmov.AlmDes NO-LOCK NO-ERROR.
        IF AVAILABLE Almacen THEN DO:
           IF Almcmov.TipMov = "I" THEN
              S-Procedencia = "Procedencia      : " + Almcmov.AlmDes + " - " + Almacen.Descripcion.
           ELSE 
              S-Procedencia = "Destino          : " + Almcmov.AlmDes + " - " + Almacen.Descripcion.   
           END.            
     END.   
     IF Almtmovm.PidRef1 THEN ASSIGN S-Referencia1 = Almtmovm.GloRf1.
     IF Almtmovm.PidRef2 THEN ASSIGN S-Referencia2 = Almtmovm.GloRf2.
     IF Almtmovm.PidRef3 THEN ASSIGN S-Referencia3 = Almtmovm.GloRf3.
  END.

  IF Almcmov.TipMov = "I" THEN DO:
/*     IF Almtmovm.PidPCo and ( S-USER-ID = "ADMIN" OR S-USER-ID = "CONTA11"  ) THEN DO:*/
     /*
     IF Almtmovm.PidPCo THEN DO:
        IF x-ContaFinan = YES THEN DO:
            /* Tesoreria */
            RUN Formato-2.
            /* Contabilidad */
            RUN Formato-C.
        END.
        ELSE DO:
            /* Proveedor */
            RUN Formato-P.
        END.
     END.
     IF x-ContaFinan = NO THEN DO:
         /* Almacen */
         RUN Formato-1.
     END.
     */

     IF x-impresora-destino = 1 THEN DO:
         /* Contabilidad */
         RUN Formato-C.
         /* Proveedor */
         RUN Formato-P.
         /* Almacen */
         RUN Formato-1.
     END.
     ELSE DO:
         /*
         /* Contabilidad */
         RUN Formato-C-RB.
         /* Proveedor */
         RUN Formato-P-RB.
         /* Almacen */
         RUN Formato-1-RB.
         */
         IF Almtmovm.PidPCo THEN DO:
            IF x-ContaFinan = YES THEN DO:
                /* Contabilidad */
                RUN Formato-C.
            END.
            ELSE DO:
                /* Proveedor */
                RUN Formato-P-RB.
            END.
         END.
         IF x-ContaFinan = NO THEN DO:
             /* Almacen */
             RUN Formato-1-RB.
         END.
     END.

  END.
  IF Almcmov.TipMov = "S" THEN DO:
     IF Almcmov.CodMov = 20 OR Almcmov.CodMov = 25 OR Almcmov.CodMov = 23 OR Almcmov.CodMov = 16 THEN RUN Formato-3 .
     ELSE RUN Formato-4.
  END.   
  
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ENDIF

&IF DEFINED(EXCLUDE-imprimir-tinta-laser) = 0 &THEN

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE imprimir-tinta-laser Procedure 
PROCEDURE imprimir-tinta-laser :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/

DEFINE INPUT PARAMETER pReportLibrary AS CHAR NO-UNDO.
DEFINE INPUT PARAMETER pReportName AS CHAR NO-UNDO.
DEFINE INPUT PARAMETER pTaskNo AS INT NO-UNDO.

DEFINE VARIABLE cDatabaseName    AS CHARACTER NO-UNDO.
DEFINE VARIABLE cHostName        AS CHARACTER NO-UNDO.
DEFINE VARIABLE cNetworkProto    AS CHARACTER NO-UNDO.
DEFINE VARIABLE cPortNumber      AS CHARACTER NO-UNDO.
DEFINE VARIABLE cOtherParams     AS CHARACTER NO-UNDO.
DEFINE VARIABLE cNewConnString   AS CHARACTER NO-UNDO.
DEFINE VARIABLE cDelimeter       AS CHARACTER NO-UNDO.

DEFINE VAR cNombreDelReporte AS CHAR.
DEFINE VAR iCopias AS INT.
DEFINE VAR iCopia AS INT.

GET-KEY-VALUE SECTION "RBParametros" KEY "cDatabaseName" VALUE cDatabaseName.
GET-KEY-VALUE SECTION "RBParametros" KEY "cHostName" VALUE cHostName.
GET-KEY-VALUE SECTION "RBParametros" KEY "cNetworkProto" VALUE cNetworkProto.
GET-KEY-VALUE SECTION "RBParametros" KEY "cPortNumber" VALUE cPortNumber.
GET-KEY-VALUE SECTION "RBParametros" KEY "cOtherParams" VALUE cOtherParams.

DEFINE VAR msgErr AS CHAR.

ASSIGN cDelimeter = CHR(32).
IF NOT (cDatabaseName = ? OR cHostName = ? OR cNetworkProto = ? OR cPortNumber = ?) THEN DO:
    DEFINE VAR x-rb-user AS CHAR.
    DEFINE VAR x-rb-pass AS CHAR.

    RUN lib/RB_credenciales(OUTPUT x-rb-user, OUTPUT x-rb-pass).
    IF x-rb-user = "**NOUSER**" THEN DO:
        msgErr = "No se pudieron ubicar las credenciales para" + CHR(10) +
                "la conexion del REPORTBUILDER" + CHR(10) +
                "--------------------------------------------" + CHR(10) +
                "Comunicarse con el area de sistemas - desarrollo".
        RETURN "ADM-ERROR".
    END.

   ASSIGN
       cNewConnString =
       "-db" + cDelimeter + cDatabaseName + cDelimeter +
       "-H" + cDelimeter + cHostName + cDelimeter +
       "-N" + cDelimeter + cNetworkProto + cDelimeter +
       "-S" + cDelimeter + cPortNumber + cDelimeter +
       "-U " + x-rb-user  + cDelimeter + cDelimeter +
       "-P " + x-rb-pass + cDelimeter + cDelimeter.

   IF cOtherParams > '' THEN cNewConnString = cNewConnString + cOtherParams + cDelimeter.
   RB-DB-CONNECTION = cNewConnString.
END.

ASSIGN
    RB-REPORT-LIBRARY = s-report-library + pReportLibrary
    RB-REPORT-NAME = pReportName  /*"gre_A4"*/
    RB-INCLUDE-RECORDS = "O"
    RB-FILTER = " w-report.task-no = " + STRING(pTaskNo) /*+  
                  " AND w-report.llave-c = '" + "T" + STRING(x-gre_header.serieGuia,"999") + "-" + STRING(x-gre_header.numeroGuia,"99999999") + "'"*/
    RB-BEGIN-PAGE = s-pagina-inicial
    RB-END-PAGE = s-pagina-final
    RB-PRINTER-NAME = s-port-name       /*s-printer-name*/
    RB-OUTPUT-FILE = s-print-file
    RB-NUMBER-COPIES = s-nro-copias.
                               .
IF USERID("DICTDB") = "ADMIN" OR USERID("DICTDB") = "MASTER" THEN DO:
    /*s-salida-impresion = 1.*/
END.

CASE s-salida-impresion:
  WHEN 1 THEN RB-PRINT-DESTINATION = "D".     /* Pantalla */
  WHEN 2 THEN RB-PRINT-DESTINATION = "".      /* Impresora */
  WHEN 3 THEN RB-PRINT-DESTINATION = "A".     /* Archivo */
END CASE.

    RUN aderb/_prntrb2 (RB-REPORT-LIBRARY,
                      RB-REPORT-NAME,
                      RB-DB-CONNECTION,
                      RB-INCLUDE-RECORDS,
                      RB-FILTER,
                      RB-MEMO-FILE,
                      RB-PRINT-DESTINATION,
                      RB-PRINTER-NAME,
                      RB-PRINTER-PORT,
                      RB-OUTPUT-FILE,
                      RB-NUMBER-COPIES,
                      RB-BEGIN-PAGE,
                      RB-END-PAGE,
                      RB-TEST-PATTERN,
                      RB-WINDOW-TITLE,
                      RB-DISPLAY-ERRORS,
                      RB-DISPLAY-STATUS,
                      RB-NO-WAIT,
                      RB-OTHER-PARAMETERS,  
                      "").

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ENDIF

